<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Binary Video Storage in SVG - Zero Loss Method</title>
    <style>
        body {
            margin: 0;
            background: #0a0a0a;
            color: #0f0;
            font-family: 'Courier New', monospace;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .method {
            border: 2px solid #0f0;
            padding: 20px;
            margin: 20px 0;
            background: rgba(0,255,0,0.05);
        }
        video {
            width: 100%;
            max-width: 640px;
            border: 1px solid #0f0;
        }
        pre {
            background: #000;
            padding: 10px;
            overflow-x: auto;
        }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #0a0;
        }
    </style>
</head>
<body>
    <!-- Component Templates -->
    <div id="templates" style="display: none;">
        <!-- SVG Structure Template -->
        <template id="svg-structure">
            <svg id="svg-base91-container"
                 xmlns="http://www.w3.org/2000/svg"
                 xmlns:xlink="http://www.w3.org/1999/xlink"
                 width="100%" 
                 height="100%"
                 viewBox="0 0 100 100"
                 preserveAspectRatio="xMidYMid meet"
                 style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; border: none; background: #000;"
                 onload="initBase91Player()">
                <!-- Fullscreen background -->
                <rect width="100%" height="100%" fill="#0a0a0a"/>
                <!-- Header -->
                <text x="50" y="5" text-anchor="middle" fill="#0f0" font-size="3" font-family="Arial, sans-serif">
                    Base91 Encoded Video (23% overhead)
                </text>
                <!-- Video player container -->
                <foreignObject x="10" y="10" width="80" height="80">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="width: 100%; height: 100%; position: relative; background: #000;">
                        <video id="svg-video-player" 
                               style="width: 100%; height: 100%; object-fit: contain; display: none;"
                               controls>
                            Your browser does not support the video tag.
                        </video>
                        <div id="status-message" 
                             style="
                                position: absolute;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%);
                                color: #0f0;
                                font-family: monospace;
                                font-size: 1.5vmin;
                                background: rgba(0, 0, 0, 0.7);
                                padding: 1vmin 2vmin;
                                border-radius: 0.5vmin;
                                white-space: nowrap;">
                            Loading video...
                        </div>
                        <!-- Fullscreen toggle button -->
                        <button id="fullscreen-btn" 
                                onclick="toggleFullScreen()"
                                style="
                                    position: absolute;
                                    bottom: 10px;
                                    right: 10px;
                                    background: rgba(0,0,0,0.7);
                                    border: 1px solid #0f0;
                                    color: #0f0;
                                    padding: 5px 10px;
                                    border-radius: 3px;
                                    cursor: pointer;
                                    font-size: 1.2vmin;
                                    z-index: 10;">
                            Toggle Fullscreen
                        </button>
                 onload="initBase91Player()">
                <rect width="100%" height="100%" fill="#0a0a0a"/>
                <text x="50" y="5" text-anchor="middle" fill="#0f0" font-size="3" font-family="Arial, sans-serif">
                    Base91 Encoded Video (23% overhead)
                </text>
                <foreignObject x="5" y="8" width="90" height="87" class="video-container">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="width: 100%; height: 100%; position: relative;">
                        <video id="svg-video-player" 
                               style="display: none; width: 100%; height: 100%; object-fit: contain;"
                               controls>
                            Your browser does not support the video tag.
                        </video>
                        <div id="status-message" style="
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            color: #0f0; 
                            text-align: center; 
                            font-family: Arial, sans-serif;
                            font-size: 1.5vmin;
                            background: rgba(0,0,0,0.7);
                            padding: 1vmin 2vmin;
                            border-radius: 0.5vmin;
                            white-space: nowrap;">
                            Loading video...
                        </div>
                        <button id="fullscreen-btn" 
                                onclick="toggleFullScreen()"
                                style="
                                    position: absolute;
                                    bottom: 10px;
                                    right: 10px;
                                    background: rgba(0,0,0,0.7);
                                    border: 1px solid #0f0;
                                    color: #0f0;
                                    padding: 5px 10px;
                                    border-radius: 3px;
                                    cursor: pointer;
                                    font-size: 1.2vmin;
                                    z-index: 10;">
                            Toggle Fullscreen
                        </button>
                    </div>
                </foreignObject>
            </svg>
        </template>
    </div>
    
    <div class="container">
        <h1>ðŸŽ¬ Binary Video in SVG - Zero Loss Storage</h1>
        
        <!-- Method 1: Custom Namespace with Safe Binary Encoding -->
        <div class="method">
            <h2>Method 1: Custom Namespace Binary Container</h2>
            <p>Stores raw binary in custom namespace using safe encoding (0% data loss)</p>
            
            <svg id="svg-binary-container" 
                 xmlns="http://www.w3.org/2000/svg"
                 xmlns:binary="data:application/octet-stream;base64,"
                 width="800" height="100" viewBox="0 0 800 100"
                 style="border: 1px solid #0f0;">
                
                <!-- Visual representation -->
                <rect width="100%" height="100%" fill="#0a0a0a"/>
                <text x="400" y="30" text-anchor="middle" fill="#0f0" font-size="16">
                    SVG with Embedded Binary Video Data
                </text>
                <text x="400" y="50" text-anchor="middle" fill="#fff" font-size="12">
                    Click "Extract & Play" to decode and play video
                </text>
                
                <!-- Binary data stored in custom element (browser ignores unknown elements) -->
                <binary:data id="video-binary-data" encoding="uint8-safe">
                    <!-- Binary data will be inserted here by JavaScript -->
                </binary:data>
                
                <!-- JavaScript decoder embedded in SVG -->
                <script type="text/javascript"><![CDATA[
                    // Decoder for binary data
                    function extractBinaryFromSVG() {
                        const dataElement = document.getElementById('video-binary-data');
                        if (!dataElement) return null;
                        
                        const encodedData = dataElement.textContent.trim();
                        return decodeSafeBinary(encodedData);
                    }
                    
                    function decodeSafeBinary(encoded) {
                        // Decode from safe format back to Uint8Array
                        const bytes = [];
                        for (let i = 0; i < encoded.length; i += 2) {
                            bytes.push(parseInt(encoded.substr(i, 2), 16));
                        }
                        return new Uint8Array(bytes);
                    }
                ]]></script>
            </svg>
            
            <div>
                <button onclick="extractAndPlayMethod1()">Extract & Play Video</button>
                <button onclick="downloadExtractedVideo()">Download Extracted MP4</button>
                <button onclick="downloadSVG('svg-binary-container', 'method1_video.svg')">Download SVG</button>
            </div>
            <video id="video-player-1" controls style="display:none; margin-top:10px;"></video>
        </div>
        
        <!-- Method 2: Unicode Private Use Area -->
        <div class="method">
            <h2>Method 2: Unicode Private Use Area (PUA) Encoding</h2>
            <p>Maps binary bytes to Unicode PUA characters (U+E000-U+E0FF)</p>
            
            <svg id="svg-pua-container"
                 xmlns="http://www.w3.org/2000/svg"
                 width="800" height="100" viewBox="0 0 800 100"
                 style="border: 1px solid #0f0;">
                
                <rect width="100%" height="100%" fill="#0a0a0a"/>
                <text x="400" y="50" text-anchor="middle" fill="#0f0" font-size="16">
                    Unicode PUA Encoded Video
                </text>
                
                <!-- Store binary as Unicode PUA characters in metadata -->
                <metadata id="pua-video-data">
                    <!-- Unicode PUA characters here (U+E000 to U+E0FF for bytes 0-255) -->
                </metadata>
            </svg>
            
            <div>
                <button onclick="extractAndPlayMethod2()">Extract & Play Video</button>
                <button onclick="downloadSVG('svg-pua-container', 'method2_pua_video.svg')">Download SVG</button>
            </div>
            <video id="video-player-2" controls style="display:none; margin-top:10px;"></video>
        </div>
        
        <!-- Method 3: CDATA with Custom Base91 Encoding -->
        <div class="method">
            <h2>Method 3: CDATA with Base91 (Most Efficient Text Encoding)</h2>
            <p>23% overhead vs 33% for Base64 - Best text-based method</p>
            
            <svg id="svg-base91-container"
                 xmlns="http://www.w3.org/2000/svg"
                 width="800" height="100" viewBox="0 0 800 100"
                 style="border: 1px solid #0f0;">
                
                <rect width="100%" height="100%" fill="#0a0a0a"/>
                <text x="400" y="30" text-anchor="middle" fill="#0f0" font-size="16">
                    Base91 Encoded Video (23% overhead)
                </text>
                <text x="400" y="60" text-anchor="middle" fill="#0f0" font-size="12">
                    Click "Extract & Play" to decode and play video
                </text>
                
                <defs>
                    <script id="base91-video-data" type="application/octet-stream">
                        <![CDATA[
                        // Base91 encoded data will be inserted here
                        ]]>
                    </script>
                </defs>
                
                <defs>
                    <script id="base91-video-data" type="application/octet-stream">
                        <![CDATA[
                        // Base91 encoded data will be inserted here
                        ]]>
                    </script>
                    
                    <script type="text/javascript">
                    <![CDATA[
                        // Fullscreen toggle function
                        function toggleFullScreen() {
                            const video = document.getElementById('svg-video-player');
                            
                            if (!document.fullscreenElement) {
                                if (video.requestFullscreen) {
                                    video.requestFullscreen();
                                } else if (video.webkitRequestFullscreen) { /* Safari */
                                    video.webkitRequestFullscreen();
                                } else if (video.msRequestFullscreen) { /* IE11 */
                                    video.msRequestFullscreen();
                                }
                            } else {
                                if (document.exitFullscreen) {
                                    document.exitFullscreen();
                                } else if (document.webkitExitFullscreen) { /* Safari */
                                    document.webkitExitFullscreen();
                                } else if (document.msExitFullscreen) { /* IE11 */
                                    document.msExitFullscreen();
                                }
                            }
                        }
                        
                        // Base91 decoder implementation
                        var base91 = {
                            // Base91 encoding table - defined as a function to avoid syntax issues
                            _b91chars: (function() {
                                // Define all Base91 characters in a safe way
                                var chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                                return chars + '!"#$%&\'()*+,./:;<=>?@[\\]^_`{|}~';
                            })(),
                            
                            // Decode Base91 string to Uint8Array
                            decode: function(input) {
                                var b = 0, n = 0, v = -1,
                                    len = input.length,
                                    out = [];
                                
                                for (var i = 0; i < len; i++) {
                                    var c = this._b91chars.indexOf(input.charAt(i));
                                    if (c === -1) continue;
                                    
                                    if (v < 0) {
                                        v = c;
                                    } else {
                                        v += c * 91;
                                        b |= v << n;
                                        n += (v & 8191) > 88 ? 13 : 14;
                                        do {
                                            out.push(b & 0xff);
                                            b >>= 8;
                                            n -= 8;
                                        } while (n > 7);
                                        v = -1;
                                    }
                                }
                                
                                if (v + 1) {
                                    out.push((b | v << n) & 0xff);
                                }
                                
                                return new Uint8Array(out);
                            }
                        };
                        
                        // Initialize the player when SVG loads
                        function initBase91Player() {
                            const statusElement = document.getElementById('status-message');
                            const video = document.getElementById('svg-video-player');
                            
                            try {
                                const scriptElement = document.getElementById('base91-video-data');
                                if (!scriptElement) {
                                    throw new Error('Video data not found');
                                }
                                
                                const base91Data = scriptElement.textContent.trim();
                                if (!base91Data) {
                                    throw new Error('No video data available');
                                }
                                
                                statusElement.textContent = 'Decoding video data...';
                                
                                // Small delay to allow UI to update
                                setTimeout(() => {
                                    try {
                                        // Decode the Base91 data
                                        const uint8Array = base91.decode(base91Data);
                                        
                                        // Create a Blob URL for the video
                                        const blob = new Blob([uint8Array], {type: 'video/mp4'});
                                        const videoUrl = URL.createObjectURL(blob);
                                        
                                        // Set up the video element
                                        video.src = videoUrl;
                                        video.style.display = 'block';
                                        statusElement.style.display = 'none';
                                        
                                        // Try to autoplay (may be blocked by browser policy)
                                        const playPromise = video.play();
                                        if (playPromise !== undefined) {
                                            playPromise.catch(error => {
                                                console.log('Autoplay prevented, showing controls');
                                                video.controls = true;
                                                statusElement.textContent = 'Click the play button to start video';
                                                statusElement.style.display = 'block';
                                            });
                                        }
                                    } catch (error) {
                                        console.error('Error processing video:', error);
                                        statusElement.textContent = 'Error loading video: ' + error.message;
                                        statusElement.style.color = '#f00';
                                    }
                                }, 100);
                                
                            } catch (error) {
                                console.error('Error initializing player:', error);
                                statusElement.textContent = 'Error: ' + error.message;
                                statusElement.style.color = '#f00';
                            }
                        }
                    ]]>
                    </script>
                </defs>
            </svg>
            
            <div>
                <button onclick="extractAndPlayMethod3()">Extract & Play Video</button>
                <button onclick="downloadSVG('svg-base91-container', 'method3_base91_video.svg')">Download SVG</button>
            </div>
            <video id="video-player-3" controls style="display:none; margin-top:10px;"></video>
        </div>
        
        <!-- Method 4: Steganographic Path Encoding -->
        <div class="method">
            <h2>Method 4: Steganographic Path Data</h2>
            <p>Hide binary data in SVG path coordinates (invisible storage)</p>
            
            <svg id="svg-stego-container"
                 xmlns="http://www.w3.org/2000/svg"
                 width="800" height="200" viewBox="0 0 800 200"
                 style="border: 1px solid #0f0;">
                
                <rect width="100%" height="100%" fill="#0a0a0a"/>
                <text x="400" y="30" text-anchor="middle" fill="#0f0" font-size="16">
                    Steganographic Binary Storage
                </text>
                
                <!-- Binary data hidden in path coordinates -->
                <!-- Each byte encoded as decimal coordinate -->
                <g id="stego-paths" opacity="0.01">
                    <!-- Paths will be generated here -->
                </g>
            </svg>
            
            <div>
                <button onclick="extractAndPlayMethod4()">Extract & Play Video</button>
                <button onclick="downloadSVG('svg-stego-container', 'method4_stego_video.svg')">Download SVG</button>
            </div>
            <video id="video-player-4" controls style="display:none; margin-top:10px;"></video>
        </div>
        
        <!-- File Input for Testing -->
        <div class="method">
            <h2>Test with Your Video</h2>
            <input type="file" id="video-input" accept="video/mp4,video/webm">
            <button onclick="processUserVideo()">Process Video</button>
            <div id="stats" style="margin-top:10px;"></div>
        </div>
        
        <!-- Code Examples -->
        <div class="method">
            <h2>Implementation Code</h2>
            <pre id="code-display"></pre>
        </div>
    </div>
    
    <script>
        // Wait for the DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // ============================================
            // Binary Encoding/Decoding Functions
            // ============================================
            
            // Method 1: Hexadecimal encoding (safe for XML)
            function encodeBinaryToHex(uint8Array) {
                return Array.from(uint8Array)
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join('');
            }
        
            function decodeHexToBinary(hex) {
                const bytes = [];
                for (let i = 0; i < hex.length; i += 2) {
                    bytes.push(parseInt(hex.substr(i, 2), 16));
                }
                return new Uint8Array(bytes);
            }
            
            // Method 2: Unicode Private Use Area encoding
            function encodeBinaryToPUA(uint8Array) {
                // Map each byte (0-255) to Unicode PUA (U+E000-U+E0FF)
                return Array.from(uint8Array)
                    .map(b => String.fromCharCode(0xE000 + b))
                    .join('');
            }
            
            function decodePUAToBinary(puaString) {
                const bytes = [];
                for (let i = 0; i < puaString.length; i++) {
                    const code = puaString.charCodeAt(i);
                    if (code >= 0xE000 && code <= 0xE0FF) {
                        bytes.push(code - 0xE000);
                    }
                }
                return new Uint8Array(bytes);
            }
            
            // Method 3: Base91 encoding (most efficient text encoding)
            class Base91 {
                constructor() {
                    this.alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!#$%&()*+,./:;<=>?@[]^_`{|}~"';
                    this.decode_table = {};
                    for (let i = 0; i < this.alphabet.length; i++) {
                        this.decode_table[this.alphabet[i]] = i;
                    }
                }
                
                encode(data) {
                    let v = 0, b = 0, n = 0;
                    let output = '';
                    
                    for (let i = 0; i < data.length; i++) {
                        b |= data[i] << n;
                        n += 8;
                        
                        if (n > 13) {
                            v = b & 8191;
                            if (v > 88) {
                                b >>= 13;
                                n -= 13;
                            } else {
                                v = b & 16383;
                                b >>= 14;
                                n -= 14;
                            }
                            output += this.alphabet[v % 91] + this.alphabet[Math.floor(v / 91)];
                        }
                    }
                    
                    if (n) {
                        output += this.alphabet[b % 91];
                        if (n > 7 || b > 90) {
                            output += this.alphabet[Math.floor(b / 91)];
                        }
                    }
                    
                    return output;
                }
                
                decode(str) {
                    const output = [];
                    let v = -1, b = 0, n = 0;
                    
                    for (let i = 0; i < str.length; i++) {
                        const c = this.decode_table[str[i]];
                        if (c === undefined) continue;
                        
                        if (v < 0) {
                            v = c;
                        } else {
                            v += c * 91;
                            b |= v << n;
                            n += (v & 8191) > 88 ? 13 : 14;
                            
                            do {
                                output.push(b & 0xFF);
                                b >>= 8;
                                n -= 8;
                            } while (n > 7);
                            
                            v = -1;
                        }
                    }
                    
                    if (v >= 0) {
                        output.push((b | v << n) & 0xFF);
                    }
                    
                    return new Uint8Array(output);
                }
            }
            
            const base91 = new Base91();
            
            // Method 4: Steganographic path encoding
            function encodeBinaryToPath(uint8Array) {
                // Hide each byte as a coordinate in an invisible path
                const paths = [];
                const chunkSize = 1000; // SVG path length limit
                
                for (let i = 0; i < uint8Array.length; i += chunkSize) {
                    const chunk = uint8Array.slice(i, i + chunkSize);
                    let path = 'M';
                    
                    for (let j = 0; j < chunk.length; j++) {
                        // Encode byte as decimal coordinate
                        const x = (j % 100) * 8; // Position
                        const y = chunk[j]; // Byte value (0-255)
                        path += `${x}.${chunk[j].toString().padStart(3, '0')},${y} `;
                        
                        if (j % 100 === 99) {
                            path += 'M'; // Start new subpath every 100 points
                        }
                    }
                    
                    paths.push(path);
                }
                
                return paths;
            }
            
            function decodePathToBinary(paths) {
                const bytes = [];
                
                for (const path of paths) {
                    // Extract decimal parts which contain our byte values
                    const matches = path.matchAll(/\.(\d{3})/g);
                    for (const match of matches) {
                        bytes.push(parseInt(match[1]));
                    }
                }
                
                return new Uint8Array(bytes);
            }
        
        // ============================================
        // Video Embedding & Extraction
        // ============================================
        
        async function embedVideoInSVG(videoFile, method = 1) {
            const arrayBuffer = await videoFile.arrayBuffer();
            const uint8Array = new Uint8Array(arrayBuffer);
            
            console.log(`Original size: ${uint8Array.length} bytes`);
            
            let svgElement, encodedData;
            
            switch(method) {
                case 1: // Hex in custom namespace
                    encodedData = encodeBinaryToHex(uint8Array);
                    svgElement = document.getElementById('svg-binary-container');
                    const binaryElement = svgElement.querySelector('binary\\:data');
                    if (binaryElement) {
                        binaryElement.textContent = encodedData;
                    }
                    console.log(`Hex encoded size: ${encodedData.length} chars (${(encodedData.length/uint8Array.length*100).toFixed(1)}% of original)`);
                    break;
                    
                case 2: // Unicode PUA
                    encodedData = encodeBinaryToPUA(uint8Array);
                    svgElement = document.getElementById('svg-pua-container');
                    const metadataElement = svgElement.querySelector('metadata');
                    if (metadataElement) {
                        metadataElement.textContent = encodedData;
                    }
                    console.log(`PUA encoded size: ${encodedData.length} chars`);
                    break;
                    
                case 3: // Base91
                    encodedData = base91.encode(uint8Array);
                    svgElement = document.getElementById('svg-base91-container');
                    const scriptElement = svgElement.querySelector('script');
                    if (scriptElement) {
                        scriptElement.textContent = encodedData;
                    }
                    console.log(`Base91 encoded size: ${encodedData.length} chars (${(encodedData.length/uint8Array.length*100).toFixed(1)}% of original)`);
                    break;
                    
                case 4: // Steganographic paths
                    const paths = encodeBinaryToPath(uint8Array);
                    svgElement = document.getElementById('svg-stego-container');
                    const pathGroup = svgElement.querySelector('#stego-paths');
                    pathGroup.innerHTML = '';
                    
                    paths.forEach((pathData, i) => {
                        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        path.setAttribute('d', pathData);
                        path.setAttribute('stroke', 'none');
                        path.setAttribute('fill', 'none');
                        path.setAttribute('data-chunk', i);
                        pathGroup.appendChild(path);
                    });
                    console.log(`Created ${paths.length} invisible paths`);
                    break;
            }
            
            // Update stats
            updateStats(videoFile, uint8Array.length, encodedData ? encodedData.length : 0);
            
            return uint8Array;
        }
        
        function createVideoFromBinary(uint8Array, videoPlayerId) {
            // Create blob from binary data
            const blob = new Blob([uint8Array], {type: 'video/mp4'});
            const url = URL.createObjectURL(blob);
            
            // Set video source
            const videoPlayer = document.getElementById(videoPlayerId);
            videoPlayer.src = url;
            videoPlayer.style.display = 'block';
            
            // Clean up URL when done
            videoPlayer.addEventListener('loadeddata', () => {
                console.log('Video loaded successfully!');
            });
            
            return url;
        }
        
        // ============================================
        // Extraction Functions for Each Method
        // ============================================
        
        window.extractAndPlayMethod1 = function() {
            const svgElement = document.getElementById('svg-binary-container');
            const binaryElement = svgElement.querySelector('binary\\:data');
            
            if (binaryElement) {
                const hexData = binaryElement.textContent.trim();
                const uint8Array = decodeHexToBinary(hexData);
                createVideoFromBinary(uint8Array, 'video-player-1');
                console.log('Extracted video from hex encoding:', uint8Array.length, 'bytes');
            }
        }
        
        window.extractAndPlayMethod2 = function() {
            const svgElement = document.getElementById('svg-pua-container');
            const metadataElement = svgElement.querySelector('metadata');
            
            if (metadataElement) {
                const puaData = metadataElement.textContent;
                const uint8Array = decodePUAToBinary(puaData);
                createVideoFromBinary(uint8Array, 'video-player-2');
                console.log('Extracted video from PUA encoding:', uint8Array.length, 'bytes');
            }
        }
        
        window.extractAndPlayMethod3 = function() {
            const svgElement = document.getElementById('svg-base91-container');
            const scriptElement = svgElement.querySelector('script');
            
            if (scriptElement) {
                const base91Data = scriptElement.textContent.trim();
                const uint8Array = base91.decode(base91Data);
                createVideoFromBinary(uint8Array, 'video-player-3');
                console.log('Extracted video from Base91 encoding:', uint8Array.length, 'bytes');
            }
        }
        
        window.extractAndPlayMethod4 = function() {
            const svgElement = document.getElementById('svg-stego-container');
            const paths = svgElement.querySelectorAll('#stego-paths path');
            
            const pathStrings = Array.from(paths).map(p => p.getAttribute('d'));
            const uint8Array = decodePathToBinary(pathStrings);
            createVideoFromBinary(uint8Array, 'video-player-4');
            console.log('Extracted video from steganographic paths:', uint8Array.length, 'bytes');
        }
        
        // ============================================
        // User Interface Functions
        // ============================================
        
        // Make sure the function is globally available
        window.processUserVideo = async function() {
            const input = document.getElementById('video-input');
            if (!input.files[0]) {
                alert('Please select a video file');
                return;
            }
            
            const file = input.files[0];
            console.log('Processing:', file.name, file.size, 'bytes');
            
            // Embed in all methods
            for (let method = 1; method <= 4; method++) {
                await embedVideoInSVG(file, method);
            }
            
            alert('Video embedded in all SVG containers! Click extract buttons to play.');
        }
        
        window.updateStats = function(file, originalSize, encodedSize) {
            const stats = document.getElementById('stats');
            const overhead = ((encodedSize / originalSize - 1) * 100).toFixed(1);
            
            stats.innerHTML = `
                <strong>File:</strong> ${file.name}<br>
                <strong>Original:</strong> ${originalSize.toLocaleString()} bytes<br>
                <strong>Encoded:</strong> ${encodedSize.toLocaleString()} chars<br>
                <strong>Overhead:</strong> ${overhead}%
            `;
        }
        
        window.downloadExtractedVideo = function() {
            const svgElement = document.getElementById('svg-binary-container');
            const binaryElement = svgElement.querySelector('binary\\:data');
            
            if (binaryElement) {
                const hexData = binaryElement.textContent.trim();
                const uint8Array = decodeHexToBinary(hexData);
                
                const blob = new Blob([uint8Array], {type: 'video/mp4'});
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'extracted_video.mp4';
                a.click();
                
                URL.revokeObjectURL(url);
            }
        }
        
        // ============================================
        // Global Function Exposure
        // ============================================
        
        // Make sure all necessary functions are available globally
        window.extractAndPlayMethod1 = extractAndPlayMethod1;
        window.extractAndPlayMethod2 = extractAndPlayMethod2;
        window.extractAndPlayMethod3 = extractAndPlayMethod3;
        window.extractAndPlayMethod4 = extractAndPlayMethod4;
        window.processUserVideo = processUserVideo;
        window.downloadExtractedVideo = downloadExtractedVideo;
        
        // ============================================
        // SVG Download Function
        // ============================================
        
        // Global function to download any SVG by ID
        // This function is called when the user clicks the download button for any method
        function downloadSVG(svgId, filename) {
            // Special handling for Base91 SVG - use the component-based template
            if (svgId === 'svg-base91-container') {
                // Get the source SVG and video data
                const sourceSvg = document.getElementById(svgId);
                const videoDataScript = sourceSvg.querySelector('script[type="application/octet-stream"]');
                
                if (!videoDataScript) {
                    console.error('No video data found in the source SVG');
                    return;
                }
                
                // Get the SVG structure template
                const svgTemplate = document.getElementById('svg-structure');
                if (!svgTemplate) {
                    console.error('SVG template not found');
                    return;
                }
                
                // Clone the template content
                const parser = new DOMParser();
                const serializer = new XMLSerializer();
                const svgString = serializer.serializeToString(svgTemplate.content);
                const doc = parser.parseFromString(svgString, 'image/svg+xml');
                const svgElement = doc.documentElement;
                
                // Find the video data script and update it
                const dataScript = svgElement.querySelector('#base91-video-data');
                if (dataScript) {
                    dataScript.textContent = videoDataScript.textContent.trim();
                }
                
                // Serialize the SVG and prepare for download
                let svgString = serializer.serializeToString(svgElement);
                
                // Add XML declaration and DOCTYPE
                const xmlDeclaration = '<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n';
                const doctype = '<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n';
                
                // Create and trigger download
                const blob = new Blob([xmlDeclaration + doctype + svgString], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename.endsWith('.svg') ? filename : `${filename}.svg`;
                document.body.appendChild(a);
                a.click();
                
                // Clean up
                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 0);
                
                return;
            }
            
            // Get the SVG element
            const svgElement = document.getElementById(svgId);
            if (!svgElement) {
                console.error('SVG element not found');
                return;
            }
            
            // Create a clone to avoid modifying the original
            const clone = svgElement.cloneNode(true);
            
            // If this is the Base91 container, use the responsive template
            if (svgId === 'svg-base91-container') {
                const base91Data = clone.querySelector('#base91-video-data').textContent.trim();
                
                // Create a new SVG document
                const parser = new DOMParser();
                const doc = parser.parseFromString(`
                    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
                    <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
                    <svg id="svg-base91-container"
                         xmlns="http://www.w3.org/2000/svg"
                         xmlns:xlink="http://www.w3.org/1999/xlink"
                         width="100%" 
                         height="100%"
                         viewBox="0 0 100 100"
                         preserveAspectRatio="xMidYMid meet"
                         style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; border: none; background: #000;"
                         onload="initBase91Player()">
                        <!-- Fullscreen background -->
                        <rect width="100%" height="100%" fill="#0a0a0a"/>
                        <!-- Header -->
                        <text x="50" y="5" text-anchor="middle" fill="#0f0" font-size="3" font-family="Arial, sans-serif">
                            Base91 Encoded Video (23% overhead)
                        </text>
                        <!-- Video player container -->
                        <foreignObject x="5" y="8" width="90" height="87" class="video-container">
                            <div xmlns="http://www.w3.org/1999/xhtml" style="width: 100%; height: 100%; position: relative;">
                                <video id="svg-video-player" 
                                       style="display: none; width: 100%; height: 100%; object-fit: contain;"
                                       controls>
                                    Your browser does not support the video tag.
                                </video>
                                <div id="status-message" style="
                                    position: absolute;
                                    top: 50%;
                                    left: 50%;
                                    transform: translate(-50%, -50%);
                                    color: #0f0; 
                                    text-align: center; 
                                    font-family: Arial, sans-serif;
                                    font-size: 1.5vmin;
                                    background: rgba(0,0,0,0.7);
                                    padding: 1vmin 2vmin;
                                    border-radius: 0.5vmin;
                                    white-space: nowrap;">
                                    Loading video...
                                </div>
                                <!-- Fullscreen toggle button -->
                                <button id="fullscreen-btn" 
                                        onclick="toggleFullScreen()"
                                        style="
                                            position: absolute;
                                            bottom: 10px;
                                            right: 10px;
                                            background: rgba(0,0,0,0.7);
                                            border: 1px solid #0f0;
                                            color: #0f0;
                                            padding: 5px 10px;
                                            border-radius: 3px;
                                            cursor: pointer;
                                            font-size: 1.2vmin;
                                            z-index: 10;">
                                    Toggle Fullscreen
                                </button>
                            </div>
                        </foreignObject>
                        <defs>
                            <script id="base91-video-data" type="application/octet-stream"><![CDATA[${base91Data}]]></script>
                            
                            <!-- Base91 Decoder Script -->
                            <script type="text/javascript">
                            //<![CDATA[
                            class Base91 {
                                constructor() {
                                    this.alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!#$%&()*+,./:;<=>?@[]^_`{|}~"';
                                    this.decode_table = {};
                                    for (let i = 0; i < this.alphabet.length; i++) {
                                        this.decode_table[this.alphabet[i]] = i;
                                    }
                                }
                                
                                encode(data) {
                                    // Implementation of Base91 encoding
                                    let v = 0, b = 0, n = 0;
                                    let output = '';
                                    
                                    for (let i = 0; i < data.length; i++) {
                                        b = (b << 8) | (data[i] & 0xff);
                                        n += 8;
                                        
                                        while (n >= 13) {
                                            v = b >>> (n - 13);
                                            output += this.alphabet[v / 91] + this.alphabet[v % 91];
                                            n -= 13;
                                            b &= ~(v << (n));
                                        }
                                    }
                                    
                                    if (n > 0) {
                                        output += this.alphabet[Math.floor(b / 91)];
                                        if (n > 7 || b % 91 > 0) {
                                            output += this.alphabet[b % 91];
                                        }
                                    }
                                    
                                    return output;
                                }
                                
                                decode(str) {
                                    let v = -1, b = 0, n = 0;
                                    const out = [];
                                    
                                    for (let i = 0; i < str.length; i++) {
                                        const c = str.charAt(i);
                                        if (!(c in this.decode_table)) continue;
                                        
                                        const cval = this.decode_table[c];
                                        if (v < 0) {
                                            v = cval;
                                        } else {
                                            v += cval * 91;
                                            b |= v << n;
                                            n += (v & 8191) > 88 ? 13 : 14;
                                            do {
                                                out.push(b & 0xff);
                                                b >>= 8;
                                                n -= 8;
                                            } while (n > 7);
                                            v = -1;
                                        }
                                    }
                                    
                                    if (v + 1) {
                                        out.push((b | v << n) & 0xff);
                                    }
                                    
                                    return new Uint8Array(out);
                                }
                            }
                            
                            // Fullscreen toggle function
                            function toggleFullScreen() {
                                const video = document.getElementById('svg-video-player');
                                if (!document.fullscreenElement) {
                                    if (video.requestFullscreen) {
                                        video.requestFullscreen();
                                    } else if (video.webkitRequestFullscreen) {
                                        video.webkitRequestFullscreen();
                                    } else if (video.msRequestFullscreen) {
                                        video.msRequestFullscreen();
                                    }
                                } else {
                                    if (document.exitFullscreen) {
                                        document.exitFullscreen();
                                    } else if (document.webkitExitFullscreen) {
                                        document.webkitExitFullscreen();
                                    } else if (document.msExitFullscreen) {
                                        document.msExitFullscreen();
                                    }
                                }
                            }
                            
                            // Initialize the player when the SVG loads
                            function initBase91Player() {
                                const statusElement = document.getElementById('status-message');
                                const video = document.getElementById('svg-video-player');
                                
                                try {
                                    // Get the Base91 data from the script tag
                                    const dataScript = document.getElementById('base91-video-data');
                                    if (!dataScript) {
                                        throw new Error('Video data not found');
                                    }
                                    
                                    const base91Data = dataScript.textContent.trim();
                                    if (!base91Data) {
                                        throw new Error('No video data found');
                                    }
                                    
                                    // Create a new instance of the Base91 decoder
                                    const base91 = new Base91();
                                    
                                    // Decode the video data
                                    const binaryData = base91.decode(base91Data);
                                    const blob = new Blob([binaryData], { type: 'video/mp4' });
                                    const videoUrl = URL.createObjectURL(blob);
                                    
                                    // Set up the video element
                                    video.src = videoUrl;
                                    video.style.display = 'block';
                                    
                                    // Handle video loading
                                    video.oncanplay = function() {
                                        statusElement.textContent = 'Ready to play';
                                        video.play().catch(e => {
                                            statusElement.textContent = 'Click to play (autoplay blocked)';
                                            video.controls = true;
                                        });
                                    };
                                    
                                    video.onerror = function() {
                                        statusElement.textContent = 'Error loading video';
                                        console.error('Video loading error');
                                    };
                                    
                                } catch (e) {
                                    statusElement.textContent = 'Error: ' + e.message;
                                    console.error('Player error:', e);
                                }
                            }
                            
                            // Initialize when the SVG is loaded
                            if (document.readyState === 'loading') {
                                document.addEventListener('DOMContentLoaded', initBase91Player);
                            } else {
                                initBase91Player();
                            }
                            //]]>
                            </script>
                        </defs>
                    </svg>
                `, 'image/svg+xml');
                
                // Serialize the SVG document to a string
                const serializer = new XMLSerializer();
                let svgString = serializer.serializeToString(doc.documentElement);
                
                // Create and trigger download
                const blob = new Blob([svgString], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename.endsWith('.svg') ? filename : `${filename}.svg`;
                document.body.appendChild(a);
                a.click();
                
                // Clean up
                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 0);
                
                return;
            }
            
            // Add the downloadSVG function to the window object
            window.downloadSVG = downloadSVG;
        });
    </script>
</body>
</html>